# Config for varying width only
# python mup_paper_experiments/build_orchastrator.py --config_generator_file mup_paper_experiments/configs/ablations_kv_reps_fsdp.py --max_concurrent 30 
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps_fsdp-4 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps_fsdp-4
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps_fsdp-thin-10tpp --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps_fsdp-thin-10tpp
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps_fsdp-thin-10tpp-2 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps_fsdp-thin-10tpp-2
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps_fsdp-10tpp --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps_fsdp-10tpp

# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps_fsdp-10tpp-coarse --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps_fsdp-10tpp-coarse
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps_fsdp-10tpp-fine --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps_fsdp-10tpp-fine
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps_fsdp-10tpp-fine-eps-2 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps_fsdp-10tpp-fine-eps-2

# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-thin --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-thin

# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-thin-bf16-fsdp --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-thin-bf16-fsdp
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-thin-bf16-no-fsdp --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-thin-bf16-no-fsdp

# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-thin-bf16-no-fsdp-eps-12-2 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-thin-bf16-no-fsdp-eps-12-2
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-thin-bf16-no-fsdp-eps-9-3 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-thin-bf16-no-fsdp-eps-9-3
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-thin-bf16-no-fsdp-eps-9-4 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-thin-bf16-no-fsdp-eps-9-4
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-thin-bf16-no-fsdp-eps-9-5 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-thin-bf16-no-fsdp-eps-9-5

# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-small-bf16-no-fsdp-1 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-small-bf16-no-fsdp-1

# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-small-bf16-no-fsdp-no-moe-1 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-small-bf16-no-fsdp-no-moe-1
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-small-bf16-no-fsdp-no-moe-2 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-small-bf16-no-fsdp-no-moe-2
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-small-bf16-no-fsdp-no-moe-3 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-small-bf16-no-fsdp-no-moe-3
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-small-bf16-no-fsdp-no-moe-4 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-small-bf16-no-fsdp-no-moe-4
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-small-bf16-no-fsdp-no-moe-6 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-small-bf16-no-fsdp-no-moe-6
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-small-bf16-no-fsdp-no-moe-7 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-small-bf16-no-fsdp-no-moe-7-2

# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-small-bf16-no-fsdp-no-moe-constant-data --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-small-bf16-no-fsdp-no-moe-constant-data
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-small-bf16-no-fsdp-no-moe-constant-data-2 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-small-bf16-no-fsdp-no-moe-constant-data-2
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-small-bf16-no-fsdp-no-moe-cerebras-style --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-small-bf16-no-fsdp-no-moe-cerebras-style
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-small-bf16-no-fsdp-no-moe-cerebras-style-2 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-small-bf16-no-fsdp-no-moe-cerebras-style-2

# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-thin-bf16-fsdp-no-moe-10 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-thin-bf16-fsdp-no-moe-10
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-small-bf16-fsdp-no-moe-11 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-small-bf16-fsdp-no-moe-11

# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-small-bf16-fsdp-no-moe-13 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-small-bf16-fsdp-no-moe-13

# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-small-bf16-fsdp-no-moe-14-no-eps --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-small-bf16-fsdp-no-moe-14-no-eps
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-small-bf16-fsdp-no-moe-14-no-eps-nolan-2 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-small-bf16-fsdp-no-moe-14-no-eps-nolan-2
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-small-bf16-fsdp-no-moe-14-no-eps-nolan-2-high-wd --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-small-bf16-fsdp-no-moe-14-no-eps-nolan-2-high-wd
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-small-bf16-fsdp-no-moe-14-no-eps-nolan-2-wd-0.2 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-small-bf16-fsdp-no-moe-14-no-eps-nolan-2-wd-0.2
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-small-bf16-fsdp-no-moe-14-no-eps-nolan-2-wd-0.18 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-small-bf16-fsdp-no-moe-14-no-eps-nolan-2-wd-0.18
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-small-bf16-fsdp-no-moe-14-no-eps-nolan-2-wd-0.2-same-iters --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-small-bf16-fsdp-no-moe-14-no-eps-nolan-2-wd-0.2-same-iters
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-small-bf16-fsdp-no-moe-14-no-eps-nolan-2-wd-0.2-same-iters-indiv-kv --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-small-bf16-fsdp-no-moe-14-no-eps-nolan-2-wd-0.2-same-iters-indiv-kv
# python crawl_wandb.py --entity krchickering-uc-davis --project ablations_kv_reps-10tpp-small-bf16-fsdp-no-moe-14-no-eps-nolan-2-wd-0.2-same-iters-indiv-kv-no-2 --output-dir /mnt/weka/home/kyle.chickering/code/nanoGPT/mup_paper_experiments/results/ablations/ablations_kv_reps-10tpp-small-bf16-fsdp-no-moe-14-no-eps-nolan-2-wd-0.2-same-iters-indiv-kv-no-2

import numpy as np

from model_family_configs import (
    kv_reps,
    kv_reps_small,
    # kv_reps_thin,
)

WEIGHT_DECAY = 0.2
WANDB_PROJECT = 'ablations_kv_reps-10tpp-small-bf16-fsdp-no-moe-14-no-eps-nolan-2-wd-0.2-same-iters-indiv-kv-no-2'
BASE_EPS = 1e-9

PROD = True
SAME_ITERS = True

base_configs = [
    *kv_reps_small
]
configs = []

learning_rate_samples = 10

# learning_rates_sp = [
#     10**p for p in np.linspace(-3.25, -1.5, learning_rate_samples)
# ] if PROD else [1e-4]

# learning_rates_mup = [
#     10**p for p in np.linspace(-3.25, -1.5, learning_rate_samples)
# ] if PROD else [1e-4]

learning_rates_mup = [
    2**p for p in np.linspace(-12, -2, learning_rate_samples)
] if PROD else [1e-4]
learning_rates_sp = learning_rates_mup

# learning_rates_mup = [
#     10**p for p in np.linspace(-2.85, -1.85, learning_rate_samples)
# ] if PROD else [1e-4]

# learning_rates_mup = [
#     10**p for p in np.linspace(-2.85, -0.85, learning_rate_samples)
# ] if PROD else [1e-4]


seeds = [42] #, 43, 44] if PROD else [43]
seeds = [43,44] if PROD else [43]
# seeds = [47, 48, 49, 50, 51] if PROD else [47]
# seeds = [42, 46] if PROD else [42]

for seed in seeds:
    for cfg in base_configs:
        # for impl in ['kyle_impl', 'xllm_impl']: #, 'standard_param_impl']:
        # for impl in ['tpv_left_impl_new_kv_2', 'tpv_left_impl_no_kv']:
        for impl in ['tpv_left_impl_no_kv', 'tpv_left_impl_new_kv_2', 'standard_param_impl']:
            mup = 'false' if impl == 'standard_param_impl' else 'true'
            for lr in learning_rates_sp if mup == 'false' else learning_rates_mup:
                new_config = cfg.get_config(prod=PROD)
                new_config['wandb_run_name'] = f"{new_config['wandb_run_name']}-lr_{lr}-wd_{WEIGHT_DECAY}-seed_{seed}"
                new_config['weight_decay'] = WEIGHT_DECAY
                new_config['learning_rate'] = lr
                new_config['min_lr'] = lr / 10
                new_config['log_wandb'] = 'true'
                new_config['wandb_project'] = WANDB_PROJECT
                new_config['seed'] = seed
                new_config['mup'] = mup
                new_config['decay_lr'] = 'true'
                new_config['decay_profile'] = 'cosine'
                new_config['impl'] = impl
                new_config['eps'] = BASE_EPS  / new_config['n_embd'] if mup == 'true' else BASE_EPS

                new_config['mup_multiplier'] = 1.0 # Width and depth are constant

                if SAME_ITERS:
                    new_config['max_iters'] = base_configs[0].get_config(prod=PROD)['max_iters']
                    new_config['warmup_iters'] = base_configs[0].get_config(prod=PROD)['warmup_iters']
                    new_config['batch_size'] = base_configs[0].get_config(prod=PROD)['batch_size']

                new_config['avg_interval'] = 120
                new_config['eval_interval'] = 500
                new_config['eval_iters'] = 250

                new_config['enable_fsdp'] = 'false'
                new_config['qos'] = 'lowprio'
                new_config['partition'] = 'lowprio'
                new_config['reservation'] = 'moe'

                # new_config['max_iters'] = 2183
                # new_config['warmup_iters'] = int(0.03 * new_config['max_iters'])

                configs.append(new_config)

if __name__ == "__main__":
    import json

    config_strings = []
    for config in configs:
        config_strings.append(json.dumps(config))

    print('\n'.join(config_strings))
